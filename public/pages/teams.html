<style>
    .grid-teams { grid-template-columns: 60px minmax(300px, 1fr) minmax(300px, 1fr); }
</style>

<div class="p-4" data-scope="teams">
    <div class="flex space-between align-center mb-4 mt-4" data-bind="user__show">
        <button class="btn btn-primary btn-large exec b" data-exec="?/init" data-bind="common.teams__show:value&&value.length===32&&!common.meta.init">LOSOVAT</button>
    </div>
    <div class="table wmax-fit" style="max-width: 900px;">
        <div class="grid grid-teams font-m">
            <div class="flex align-center justify-center h-10 border-bottom bg-primary radius-lt b">Pořadí</div>
            <div class="flex align-center justify-center h-10 border-bottom bg-primary b">Jméno týmu</div>
            <div class="flex align-center justify-center h-10 border-bottom bg-primary radius-rt b">Jména hráčů</div>
        </div>
        <div data-bind="common.teams__template" class="font-m">
            <script type="text/html">
                {{ foreach team in value }}
                <div class="grid grid-teams bg-primary grid-row hover_children-bg-accent {{ isadmin('pointer') }}" onclick="EXEC('teams/edit', {{ $index }})">
                    <div class="flex align-center justify-end h-8 border-bottom">{{ $index + 1 }}.</div>
                    <div class="flex align-center justify-center h-8 border-bottom">{{ team.id | teamname }}</div>
                    <div class="flex align-center justify-center h-8 border-bottom">{{ team.id | player_names }}</div>
                </div>
                {{ end }}
                {{ if value.length < 32 }}
                <div class="pointer">
                    <div class="bg-primary-inverted p-6 text-black-inverted" onclick="EXEC('teams/add')">
                        <i class="fa fa-plus-circle mr-2"></i>Přidat dvojici
                    </div>
                </div>
                {{ fi }}
            </script>
        </div>
        <div class="radius-lb radius-rb h-2 bg-primary">
        </div>
    </div>
</div>

<script>
    common.teams = [];

    PLUGIN('teams', function(exports){
        exports.reload = function() {
            AJAX('GET /api/teams/', (val, err) => {
                if (!err && val?.length) {
                    val.quicksort('number');
                    SET('common.teams', val);
                }
            });
        };

        exports.add = function() {
            console.log('ADD');
            SET('teamform', { id: 'team' + common.teams.length, number: common.teams.length + 1, name: 'Team ' + (common.teams.length + 1), isnew: true });
            SET('common.form', 'teamform');
        };

        exports.edit = function(index) {
            if (!user?.admin)
                return;
            console.log('EDIT');
            var team = common.teams[+index];
            SET('teamform', team);
            SET('common.form', 'teamform');
        };
        
        exports.init = function() {
            SET('common.meta.init', true);
            var dots = [];
            SETTER('loading/show', 'Generuji');
            var interval = setInterval(() => {
                dots.push('.');
                SETTER('loading/show', 'Generuji' + dots.join(''));
            }, 3000);
            AJAX('GET /api/matches/init', function(val, err, res){
                clearInterval(interval);
                SETTER('loading/hide');
                if (!err) {
                    EXEC('common/savemeta');
                    SETTER(true, 'notify/success', 'Slosování proběhlo úspěšně.');
                    SET('common.page', 'matches');
                } else {
                    SETTER(true, 'notify/warning', 'Slosování selhalo. Zkuste to znovu.');
                }
            });
        };
        
    });

</script>