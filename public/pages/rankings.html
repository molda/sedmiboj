<style>
    .grid-winners { grid-template-columns: 60px minmax(300px, 1fr) repeat(7, 90px) 50px 200px; }
</style>

<div class="px-4">
    <div class="flex space-between align-center my-2">
        <button class="btn btn-primary exec" data-exec="?/reload"><i class="fa fa-refresh mr-2"></i>Obnovit</button>
    </div>
    <div class="table">
        <div class="grid grid-winners font-m bg-primary">
            <div class="flex align-center justify-center h-10 border-bottom radius-lt b">Pořadí</div>
            <div class="flex align-center justify-center h-10 border-bottom b">Jméno týmu</div>
            <div class="flex align-center justify-center h-10 border-bottom text-white bg-tennis">Tenis</div>
            <div class="flex align-center justify-center h-10 border-bottom text-white bg-pingpong">Pingpong</div>
            <div class="flex align-center justify-center h-10 border-bottom text-white bg-football">Fotbal</div>
            <div class="flex align-center justify-center h-10 border-bottom text-white bg-voleyball">Volejbal</div>
            <div class="flex align-center justify-center h-10 border-bottom text-white bg-basketball">Basketbal</div>
            <div class="flex align-center justify-center h-10 border-bottom text-white bg-handball">Házená</div>
            <div class="flex align-center justify-center h-10 border-bottom text-white bg-netball">Nohejbal</div>
            <div class="flex align-center justify-center h-10 border-bottom b"><i class="far fa-trophy-alt"></i><i class="far fa-long-arrow-alt-down ml fa-fw pointer exec sort_wins" data-exec="?/sort_wins"></i></div>
            <div class="flex align-center justify-center h-10 border-bottom radius-rt b">Počet bodů<i class="far fa-long-arrow-alt-down ml fa-fw pointer exec text-lightgray sort_points" data-exec="?/sort_points"></i></div>
        </div>
        <div data-bind="common.rankings__template" class="font-m">
            <script type="text/html">
                {{ foreach team in value }}
                <div class="grid grid-winners bg-primary grid-row hover_children-bg-accent">
                    <div class="flex align-center justify-end h-8 border-bottom">{{ $index + 1 }}.</div>
                    <div class="flex align-center justify-center h-8 border-bottom">{{ team.id | player_names }}</div>
                    <div class="flex align-center justify-center h-8 border-bottom{{ if team.active === 'tennis' }} bg-theme{{ fi }}">{{ team.scores.tennis }}</div>
                    <div class="flex align-center justify-center h-8 border-bottom{{ if team.active === 'pingpong' }} bg-theme{{ fi }}">{{ team.scores.pingpong }}</div>
                    <div class="flex align-center justify-center h-8 border-bottom{{ if team.active === 'football' }} bg-theme{{ fi }}">{{ team.scores.football }}</div>
                    <div class="flex align-center justify-center h-8 border-bottom{{ if team.active === 'voleyball' }} bg-theme{{ fi }}">{{ team.scores.voleyball }}</div>
                    <div class="flex align-center justify-center h-8 border-bottom{{ if team.active === 'basketball' }} bg-theme{{ fi }}">{{ team.scores.basketball }}</div>
                    <div class="flex align-center justify-center h-8 border-bottom{{ if team.active === 'handball' }} bg-theme{{ fi }}">{{ team.scores.handball }}</div>
                    <div class="flex align-center justify-center h-8 border-bottom{{ if team.active === 'netball' }} bg-theme{{ fi }}">{{ team.scores.netball }}</div>
                    <div class="flex align-center justify-center h-8 border-bottom">{{ team.wins }}</div>
                    <div class="flex align-center justify-center h-8 border-bottom b">{{ team.total }}</div>
                </div>
                {{ end }}
            </script>
        </div>
        <div class="radius-lb radius-rb h-2 bg-primary">
        </div>
    </div>  
</div>

<script>
    PLUGIN(function(exports){
        exports.reload = function() {
            console.log('reload rankings');
            SETTER('loading/show');
            AJAX('GET /api/rankings', function(value, err, res){
                //value = value.quicksort('wins_desc');
                value.sort(compareWins);
                SET('common.rankings', value);
                SETTER('loading/hide', 100);
            });
        };

        exports.sort_wins = function(el) {
            SET('common.rankings', common.rankings.sort(compareWins));
            el.rclass('text-lightgray');
            el.parent().parent().find('div > i.sort_points').aclass('text-lightgray');
        };

        exports.sort_points = function(el) {
            SET('common.rankings', common.rankings.sort(comparePoints));
            el.rclass('text-lightgray');
            el.parent().parent().find('div > i.sort_wins').aclass('text-lightgray');
        };

        function comparePoints(a, b) {
            if (a.total > b.total) {
                return -1;
            }
            if (a.total === b.total) {
                let amax = getMaxPoints(a.scores);
                let bmax = getMaxPoints(b.scores);
                return amax > bmax ? -1 : amax === bmax ? 0 : 1;
            }
            if (a.total < b.total) {
                return 1;
            }
            return 0;
        }

        function compareWins(a, b) {
            if (a.wins > b.wins) {
                return -1;
            }
            if (a.wins === b.wins) {
                let amax = getMaxPoints(a.scores);
                let bmax = getMaxPoints(b.scores);
                return amax > bmax ? -1 : amax === bmax ? 0 : 1;
            }
            if (a.wins < b.wins) {
                return 1;
            }
            return 0;
        }

        function getMaxPoints(scores) {
            var points = 0;
            Object.keys(scores).forEach(s => {
                if (s > points)
                    points = s;
            });
            return points;
        }
    });
</script>